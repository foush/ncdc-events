<link rel="import" href="../../../bower_components/polymer/polymer.html">
<script src="../../../bower_components/moment/moment.js"></script>

<link rel="import" href="ncdc-schedule-time.html">
<link rel="import" href="ncdc-schedule-slot.html">
<dom-module id="ncdc-schedule">
    <style>
        :host {
            display: block;
        }

    </style>
    <template>
        <h2>[[_date(start)]]</h2>
        <table class="table table-bordered table-striped">
            <thead>
                <tr>
                    <th>Time</th>
                    <template is="dom-repeat" items="[[_rooms]]" as="room" sort="_sortRooms">
                        <th>[[room]]</th>
                    </template>
                </tr>
            </thead>
            <tbody>
                <template is="dom-repeat" items="{{_slots}}" as="slot" sort="_sortSlots" id="rows">
                    <tr is="ncdc-schedule-time" slot="{{slot}}" rooms="[[_rooms]]"></tr>
                </template>
            </tbody>
        </table>
    </template>

    <script>
        (function () {
            'use strict';

            Polymer({
                is: 'ncdc-schedule',
                properties: {
                    title: {
                        type: String
                    },
                    sessions: {
                        type: Array,
                        observer: '_onSessionsChange'
                    },
                    day: {
                        type: Date,
                        observer: '_onDayChange'
                    }
                },

                ready: function() {
                },
                _onDayChange: function(newValue, oldValue) {
                    this._start = moment(newValue).set({hour: 0, minute: 0, second: 0}).valueOf();
                    this._end = moment(newValue).set({hour: 23, minute: 59, second: 59, millisecond: 999}).valueOf();// milliseconds
                },
                _onSessionsChange: function(newValue, oldValue) {
                     // scan through all sessions,
                    var startMap = {};
                    var roomMap = {};

                    for (var i = 0; i < newValue.length; i++) {
                        var session = newValue[i];
                        var start = (new Date(session.start.trim()+'.000-0400')).getTime();
                        if (start < this._start) {
                            continue;
                        }
                        var end = (new Date(session.end.trim()+'.000-0400')).getTime();
                        if (end > this._end) {
                            continue;
                        }
                        for (var j = 0; j < session.rooms.length; j++) {
                            roomMap[session.rooms[j]] = true;
                        }
                        if (!startMap[start]) {
                            startMap[start] = {start: start, end: end, sessions: []}
                        }
                        startMap[start].sessions.push(session);
                    }
                    this.set('_rooms', this._each(roomMap, function(key, val) {
                        return key;
                    }).sort(this._sortRooms));
                    this.set('_slots', this._each(startMap, function(key, slot) {
                        return slot;
                    }));
                },
                _each: function(obj, callback) {
                    var result = [];
                    for (var key in obj) {
                        if (obj.hasOwnProperty(key)) {
                            result.push(callback(key, obj[key]));
                        }
                    }
                    return result;
                },
                _sortSlots: function(slot1, slot2) {
                    return slot1.start - slot2.start;
                },
                _sortSessions: function(session1, session2) {
                    return this._sortRooms(session1.rooms[0], session2.rooms[0]);
                },
                _sortRooms: function(room1, room2) {
                    return room1 > room2 ? 1 : -1;
                },
                _date: function(ts) {
                    return moment(new Date(ts)).format('dddd, MMMM Do YYYY')
                }
            });
        })();
    </script>

</dom-module>
